---
import "../../styles/reset.css";
import "../..//styles/campbell.css";
import { SEO } from "astro-seo";
const siteName = "あづみのメモ帳";

Astro.props.title = "Webカメラ照準器";
Astro.props.description = "スマホなどを照準器にできるWebアプリです。";
const title = Astro.props.title;
const showTitle: boolean = title != siteName;
const pageTitle: string = `${showTitle ? title + " – " : ""}${siteName}`;
---

<!doctype html>
<html lang="ja">
    <head>
        <meta name="viewport" content="width=device-width" />
        <meta name="generator" content={Astro.generator} />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <SEO
            title={pageTitle}
            description={Astro.props.description}
            charset="UTF-8"
            openGraph={{
                basic: {
                    title: pageTitle,
                    type: "website",
                    image: new URL(Astro.props.ogImage ?? "ogImageDefault.jpg", Astro.url.origin).toString(),
                },
                optional: {
                    description: Astro.props.description,
                    locale: "ja_JP",
                    siteName: siteName,
                },
            }}
            twitter={{
                card: Astro.props.summaryLargeImage ? "summary_large_image" : "summary",
                site: "@DG_7D",
                creator: "@DG_7D",
            }}
        />
    </head>
    <body>
        <video id="liveView" muted playsinline> </video>
        <div id="sight"></div>
        <div id="settings">
            <span>画角/換算mm</span>
            <label for="focalLV">表示</label><input type="number" inputmode="numeric" id="focalLV" value="28" />
            <label for="focalSight">照準</label><input type="number" inputmode="numeric" id="focalSight" value="100" />
            <label for="distance">撮影距離/m (0:無限遠)</label><input type="number" inputmode="numeric" id="distance" value="0" />
            <span>視差/mm</span>
            <label for="parallaxX">右</label><input type="number" inputmode="numeric" id="parallaxX" value="0" />
            <label for="parallaxY">上</label><input type="number" inputmode="numeric" id="parallaxY" value="0" />
        </div>
        <script>
            const liveView = document.getElementById("liveView")! as HTMLVideoElement;
            const sight = document.getElementById("sight")!;

            const getInputElementById = (id: string) => document.getElementById(id)! as HTMLInputElement;
            const focalLV = getInputElementById("focalLV");
            const focalSight = getInputElementById("focalSight");
            const distance = getInputElementById("distance");
            const parallaxX = getInputElementById("parallaxX");
            const parallaxY = getInputElementById("parallaxY");
            const inputs = [focalLV, focalSight, distance, parallaxX, parallaxY];

            let ratioLV = 16 / 9;

            const localStorageNumber = {
                setItem: function (key: string, value: number): void {
                    localStorage.setItem(key, value.toString());
                },
                getItem: function (key: string): number {
                    return Number(localStorage.getItem(key));
                },
            };

            function activateLiveView() {
                navigator.mediaDevices
                    .getUserMedia({
                        audio: false,
                        video: {
                            resizeMode: "none",
                            facingMode: { ideal: "environment" },
                        },
                    })
                    .then((stream) => {
                        console.log(stream.getVideoTracks()[0].getCapabilities());
                        console.log(stream.getVideoTracks()[0].getSettings());
                        ratioLV = stream.getVideoTracks()[0].getSettings().aspectRatio ?? ratioLV;
                        liveView.srcObject = stream;
                        liveView.play();
                    });
            }

            function initSettings() {
                inputs.forEach((input) => {
                    if (localStorage.getItem(input.id)) {
                        input.value = localStorage.getItem(input.id)!;
                    } else {
                        localStorage.setItem(input.id, input.value);
                    }
                });
            }
            function applySettings() {
                const focalLVNumber = Math.max(1, localStorageNumber.getItem("focalLV"));
                const focalSightNumber = Math.max(focalLVNumber, localStorageNumber.getItem("focalSight"));
                const sightInsetPercent = ((1 - focalLVNumber / focalSightNumber) / 2) * 100;

                const distanceNumber = Math.max(0, localStorageNumber.getItem("distance"));
                if (distanceNumber == 0) {
                    sight.style.inset = sightInsetPercent.toString() + "%";
                    return;
                }

                const parallaxXNumber = localStorageNumber.getItem("parallaxX");
                const sightOffsetXPercent = (parallaxXNumber / ((36 * distanceNumber * 1000) / focalLVNumber)) * 100;
                sight.style.left = (sightInsetPercent - sightOffsetXPercent).toString() + "%";
                sight.style.right = (sightInsetPercent + sightOffsetXPercent).toString() + "%";
                sight.style.top = sightInsetPercent.toString() + "%";
                sight.style.bottom = sightInsetPercent.toString() + "%";
            }

            addEventListener("load", () => {
                initSettings();
                applySettings();
                activateLiveView();
            });
            inputs.forEach((input) => {
                input.addEventListener("input", () => {
                    localStorage.setItem(input.id, input.value);
                    applySettings();
                });
            });
        </script>
        <style lang="scss">
            :root {
                color-scheme: dark;
                --background-color: var(--black);
                --main-shadow: var(--bblack);
                --main-color: var(--bwhite);
                --sub-color: var(--white);
                --link-color: var(--byellow);

                @media (prefers-color-scheme: light) {
                    color-scheme: light;
                    --background-color: var(--bwhite);
                    --main-shadow: var(--white);
                    --main-color: var(--black);
                    --sub-color: var(--bblack);
                    --link-color: var(--blue);
                }
            }
            body {
                overflow: hidden;
                color: var(--main-color);
                width: fit-content;
                height: fit-content;
            }
            video#liveView {
                position: static;
                max-width: 100vw;
                max-height: 100vh;
            }
            div#sight {
                position: absolute;
                z-index: 1;
                inset: 25%;
                border: 2px solid red;
            }
            div#settings {
                position: absolute;
                z-index: 2;
                top: 0;
                left: 0;
                // display: none;
                * {
                    margin: 0.25em;
                }
                label {
                    text-shadow: 0 0 2px var(--background-color);
                }
                input[type="number"] {
                    width: 3em;
                }
            }
        </style>
    </body>
</html>
