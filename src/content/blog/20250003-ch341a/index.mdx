---
publish: false
title: "CH341A搭載ROM焼き機をUSBシリアル変換器として使ってArduinoに書き込んでみた"
publishDate: 9999-12-31 00:00:00 +09:00
description: "ROM焼き器として使われるCH341A搭載基板をUSBからUARTやSPIへの変換器として使い、ATtinyにスケッチやブートローダを書き込んでみた話。"
---

[前回](/blog/20250002-attiny-platformio/)紹介した通り、Optibootを書き込み「Arduino化」したAVRマイコンはUARTで書き込むことができる。UART接続にはArduino互換機に搭載されているWCHのUSBシリアル変換IC、CH340を用いた。ところで、マザーボードのBIOS等のROM(フラッシュメモリやEEPROM)を読み書きする(ROM焼き)ためによく使われるものとして、CH341Aと呼ばれるものがある。パソコンとUSB接続でき、ROMチップを接続するZIFソケットがついている基板で、特に「CH341A Mini Programmer」と書かれているもの(以下「ROM焼き器」と呼称)がよくアリエク等で出回っている。

## CH341Aとは

「CH341A」はこの基板の代名詞のように用いられるが、実際はUSBからROMとの通信に用いるSPI/I2Cへの変換を担う、CH340と同じ製造元のIC部分の名前である。

PDF直リンクではないため発見されにくいが、[公式サイト](https://www.wch-ic.com/downloads/CH341DS1_PDF.html)からデータシートを入手することができる。CH341シリーズは、CH340で使える非同期シリアル通信(UART)に加え、同期式シリアル通信(SPI, I2C)やパラレル通信(プリンタポート(標準パラレル?), EPP(拡張パラレル), MEM?)への変換機能が追加されていて、CH341Aでは全てに対応している。これらはモードを切り替えて使うことができ、CH340同様にUARTが仮想COMポートで扱える非同期シリアルモード(以下「UARTモード」)、プリントポートをUSBプリンタとして扱えるプリンタポートモード、パラレル通信と同期式シリアル通信を独自APIで扱えるモード(以下「独自APIモード」)がある。

CH341は、起動時にACT#ピンが2 kΩ抵抗を介してGNDに落とされていれば独自APIモードで起動し、浮いていればSDA, SCLピンの配線によってモードを切り替える。SDA, SCLピンを浮かせるとUARTモード、SDAをGNDに落とすと独自APIモード、SDAとSCLを接続するとプリンタポートモードになる。また、SDAとSCLを外部EEPROMに接続することでその他の設定を読み込むこともできるようである。BIOS ROMはSPIインタフェースのフラッシュメモリ(25なんちゃら)やI2CインタフェースのEEPROM(24なんちゃら)であることが多く、ROM焼き器として使う際は独自APIを介して同期式シリアル通信が使用される。

ROM焼き器は製造元すら不明であるため公式の情報を得ることは難しいが、[有志が作成した回路図](https://www.onetransistor.eu/2017/08/ch341a-mini-programmer-schematic.html)が存在する。これを見れば分かる通り、ROM焼き器ではACT#ピンをGNDに落とすかをジャンパピンで切り替えることができるようになっている。通常はACT#は「1-2」に刺さったジャンパピンでGNDに落とされていて、問答無用で独自APIモードで起動する。ジャンパを「2-3」に刺しかえるとモード切替ができるようになり、SDA, SCLを浮かせる(ソケットに何も接続しない)状態で起動すればUARTモードになる。使うことはほぼないと思われるが、SDAもSCLもソケットに出てきているため、両者を接続すればプリンタポートモードで、SDAをGNDに落とせば独自APIモードで起動することもできる。

## 電圧修正

多くのページで指摘されている通り、ROM焼き器には設計ミスが存在する。ソケットからROMに与える電源電圧はLDOを介した3.3 Vであるのに対し、CH341Aは5 Vで駆動されており、ロジック電圧が5 Vになってしまっている。ほとんどのICは電源電圧以上のロジック電圧を受け付けないため、このままでは書き込み対象を破壊する恐れがある。たとえば、ATtiny44ではピン電圧の絶対最大定格がVCC+0.5 Vであるため、3.3 V駆動時に5 Vの入力は認められない。

CH341AのVCCピンを基板から剥がし、このVCCピンとV3ピンを3.3 Vラインに接続することで、CH341Aを3.3 Vで駆動するよう修正することができる。これをするとピンヘッダから出るUARTの電圧も3.3 Vになるため、通信対象のICも3.3 Vで駆動するようにする。5 V駆動のICも3.3 Vで十分HIGHと認識することが多く、たとえば、ATtiny44のV_IHの最小は0.6 VCCで、5 V駆動でも3.0 Vなため、3.3 Vは十分HIGHと認識される。しかし、ICを5 Vで駆動しているとCH341AのRXに入る電圧が5 Vになってしまい、これは認められていないため、こんどはCH341A側の破損リスクが生じる。3.3 Vで駆動できないICを対象にするときは、素直にCH340K等の5 Vトレラントな子を使うべきである。

## ドライバインストール

ROM焼き器ではよく怪しいソフトウェアに同梱されたドライバをインストールするよう促されるが、実際には[WCH公式のドライバ](https://www.wch-ic.com/search?t=all&k=CH341)を使うことができる。ドライバは`CH341SER.EXE`と`CH341PAR.EXE`の2つがある。

`CH341SER.EXE`はCH340やUARTモードのCH341のドライバであり、仮想COMポートが作成される。わざわざダウンロードしなくてもWindows Updateから自動でインストールされる。一方、`CH341PAR.EXE`はCH341の独自APIモードのドライバである。Windows Updateからはインストールされない。また、アプリケーションによってはWinUSBやlibusbドライバが必要なこともある。これらはUSB機器をほぼ直接触ることのできる汎用のドライバで、WCHが用意したライブラリを用いず、アプリケーションが比較的低レイヤな操作まで担当する場合に使うようである。[Zadig](https://zadig.akeo.ie/)を使うことで、簡単にこれらのドライバを適用することができる。なお、プリンタポートモードではWindows標準の`usbprint.sys`が使われる。

## UARTで書き込み

ジャンパピンを「2-3」に差し替えてソケットに何も接続しない状態で起動するとUARTモードになり、CH340と同じように使うことができる。

UARTのピンはソケットにこそ出てきていないものの、ソケットの横のピンヘッダに出てきている。配置は裏面に印字されている。3.3 V、GNDはそのままVCC、GNDに接続し、RX/TXはCH341にとってのRX/TXなので、RXをATtinyのTXに、TXをRXに接続する。

自動リセットに使うDTRはピンヘッダには出ていないが、UARTモードでのDTRピンは、SPIモードでのMOSIピンと共通であり、反対側のピンヘッダのMOSIかSPI ROMのソケットの5番ピンから引き出すことができる。これを0.1 μFのコンデンサを介してATtinyのRESETピン(プルアップは内蔵されている)に接続することで自動リセットが可能になる。

## SPIで書き込み?

Optiboot自体の書き込みに用いられるISPも、フラッシュメモリ同様SPIによる通信で行われるため、CH341から直接行うことができる。SPIはCOMポートのように汎用的には扱えないためアプリケーション側での個別対応が必要であるが、幸い通常AVRマイコンの書き込みに使われる[AVRDUDE](https://github.com/avrdudes/avrdude/releases)はCH341Aにも対応している。PlatformIOに同梱されているものやwingetでインストールできるMSVCビルドではCH341Aに対応していないため、MSYS2 mingwビルドをダウンロードしてくる必要がある。また、CH341Aのドライバも公式ではなく汎用ドライバをZadigで適用する必要がある。WinUSB、libusb-win32、libusbKのいずれかを選択できるが、どれでも動作するようである(libusb.hしか使ってなくてもWinUSBでもlibusbKでもいけるものなんだ)。

SPIの各ピンもソケットだけでなくピンヘッダにも出てきてくれているため、UARTと同様にジャンパ線で接続できる。ピン配置はほぼArduino as ISPと同じであるが、ATtinyのRESETピンに接続するのがCH341AのCSピンである点のみ異なる。

## ROM焼き

本来の使い方であるROM焼きについても触れておく。CH341AからROMを焼くためのソフトウェアはいくつも存在するが、[AsProgrammer](https://github.com/nofeletru/UsbAsp-flash)というものがオープンソースで素性が知れているため無難かもしれない。

また、コマンドラインツールとしてはLinuxでよく使われるflashromの[Windows版](https://github.com/therealdreg/flashrom_build_windows_x64)もCH341Aに対応している。ドライバはZadigから適用する必要がある。

## あとがき

ROM焼き専用に使われがちなCH341搭載ボードが一般的なシリアル変換器やISP書き込み器としても使える汎用性を持っていることを知ることができたのは、まあまあ大きな収穫である。特に、Arduino UNOを一台潰す必要があり取り回しの悪いArduino as ISPを使わなくても済むようになるのは便利である。