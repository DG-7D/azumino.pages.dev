---
publish: true
title: "iPhoneのWebカメラの挙動とセンサの仕様を調べてみた"
publishDate: 2023-12-31
description: "iPhoneのブラウザ上で取得できるカメラ映像の画角などを調べていたら、最終的にイメージセンサとかイメージサークルの大きさにまでたどり着いた話。"
---

import Img from "../../components/Img.astro";

Webカメラ照準器なるものを作った。ほとんど実用性のないツールであるが、できる範囲で正確にしてみようと試みた。その際、iPhoneなどのスマホのブラウザ上で取得できるWebカメラ映像の画角を正確に知る必要があった。

## Webカメラをいじれるようにする

Webカメラは、`getUserMedia()`を実行することで使えるようになる。このとき、引数に適当な制約を書いた`MediaTrackConstraints`オブジェクト(?)を渡してやると、その制約を満たすよう努力してくれる。たとえば、カメラの向き(前面or背面)、縦横比、縦横解像度などを指定することができる。

ところで、Webカメラはlocalhostかhttpsでしか使用できない。つまり、ローカルでサーバを立てられない(こともないだろうけどめんどい)iPhone上でテストしたければ、いったんサイトにデプロイするか、ローカルでhttpsできるようにしないといけない。パラメータを検証するためにいちいちデプロイし直すのはめんどいので、制約をJSON形式で自由に入力することができる[Webカメラテストページ](/misc/webCameraTest/)を作った。`getCapabilities()`や`getSettings()`の出力も雑に確認できるようにしてある。

## 画角を調べる

まずは背面カメラとだけ指定(`facingMode: "environment"`)して表示させてみると、4:3の映像が現れた。これはOS標準アプリで静止画を撮影した際の縦横比と同じであり、イメージセンサの縦横比でもある。では、静止画と同じ範囲写っているのかというと、そうではなく、若干小さい範囲が映し出されている。ちなみに、iPhone SE (第3世代)の通常の静止画撮影時の焦点距離(おそらく35mm判換算)は、「写真」アプリ上では28mmと記載されている。

Webカメラの出力は動画なので、静止画と違うことは十分想定できた現象である。たとえばα7 IVでも、4K60pの動画を撮影する際にはAPS-Cサイズにクロップされる。では、動画撮影時と同じ画角なのかといえば、そうでもなく、それよりはだいぶ広い範囲が映っているようである。ちなみに、動画撮影時の画角は、撮影中に静止画ボタンを押して撮影した画像によれば、34mmである。

よくわからないので要求する縦横比を変更してみる。順当に16:9(1.7777...)を指定してみるとどうだろうか。結果は、短辺方向は4:3と同じ範囲、長辺方向はより広い範囲が映った。つまり、縦方向に縮むのではなく、横方向に伸びた。当然同じ16:9な動画撮影時より広い範囲である。2:1などさらに細長くしてみると、こんどは縦方向に縮んだ。どうやら、他の縦横比の映像は、16:9の映像から切り出されているようである。なお、大小の解像度を具体的に指定しても画角は変わらなかった。

ここで奇妙なことに気づく。よく見ると、通常の静止画では映っていなかった範囲が、Webカメラの16:9の映像には含まれているのである。長辺は広く、短辺は狭くなっている。正確に比較してみると、対角線の画角が同じになるように、つまり、35mm判換算の焦点距離で画角を表現すれば同じ値になるようになっているようである。

よって、少なくともiPhone SE (第3世代)では、16:9の映像を取得すれば、35mm判換算で28mmの画角として計算できる、ということになる。なお、`width`か`height`のどちらかのみを指定すると、縦横比は初回は16:9(4:3じゃないんだ)、以降は前回の状態によって決まるようである。よく分からない挙動なので、16:9を明示しておくのが安全と思われる。

## センサが余ってる?

一部でも4:3の写真よりも広い範囲を取得できるということは、イメージセンサは4:3であるのに、写真を撮影する際にそれを使いきっていないということになる。

iPhone SE (第3世代)に搭載されているとされるIMX315イメージセンサの大きさは、Wikipedia~~から消し飛ばされた表~~によれば、対角8.67mm(1/2.93インチ)、長辺6.94mm、短辺5.20mmになる。「35mm判換算焦点距離」の基準となる35mm判のセンササイズは長辺36mm、縦24mm、対角43.3mmである。

ExifToolを用いて表示してみると、視野角の記載もある。視野角65.5°、焦点距離28.0mmのときのセンサ上での長さは、28*tan(65.5°/2)*2=36.0mmとなる。どうやらここでの換算焦点距離は長辺基準のようである。換算焦点距離が実焦点距離の7倍であるから、実際のセンサ上での大きさは、長辺36÷7=5.14mm、短辺3.86mm、対角6.43mmである。

```
Field Of View                   : 65.5 deg
Focal Length                    : 4.0 mm (35 mm equivalent: 28.0 mm)
```

カメラアプリで任意の解像度を選択し、イメージサークル内で。

低フレームレートでもいいので録画に使えたら面白いのにな、とは思う。

なお、SONYのXperiaでは1型センサを盛大に余らせている。

## まとめ

iPhone SE (第3世代)、iPhone SE (第2世代)において以下が言える。

### 確実に言えること

- 通常の静止画撮影ではセンサ全域を使いきっていない
- Webカメラとしては、通常の静止画撮影と同じ対角線画角で、16:9の映像を得ることができる
- Webカメラで16:9以外の映像を要求した場合、16:9から切り出される。

### IMX315の仕様が正しければ言えること

- 

## 参考

- [Exmor - Wikipedia](https://en.wikipedia.org/w/index.php?title=Exmor&oldid=1156115127)