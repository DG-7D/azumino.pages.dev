---
publish: false
title: "Astroで更新履歴を自動生成してみた"
publishDate: 9999-12-31
description: "Astroでサイトの更新履歴をGitのコミット履歴から自動生成してみた話。"
---

個人サイトあるあるに「更新履歴」なる項目があるが、手動で追加していたのでは忘れそう(実際忘れてる人いた)。

## 自動生成する

サイトの内容は当然(?)Gitで管理しているので、更新履歴はコミット履歴を取得すればいい。実は当初からこのようにする予定だったので、主ブランチへのマージはFast-Forwordにせずある程度まとまった更新内容をメッセージとしている。

Astroはビルド時にJavaScript/TypeScriptを実行して静的なhtmlを生成するわけだが、JS上ではローカルのコマンドを実行することができる。つまり、`git log`を実行することができる。

`--first-parent`を使うことで、マージ元のコミットを除いて列挙することができる。

`--format`を使えばJSで扱いやすい形、つまりJSONっぽい形で吐かせることもできる。

```ts
let git: string;

if (os.platform() == "linux") {
    git = execSync('git log --format=\'{"date":"%ad","message":"%s"},\' --date=short --first-parent').toString();
} else if (os.platform() == "win32") {
    git = execSync('git log --format="{\\""date\\"":\\""%ad\\"",\\""message\\"":\\""%s\\""}," --date=short --first-parent').toString();
} else {
    return;
}
```

## 罠

`git fetch --unshallow`を実行することで完全な履歴を取得することができる。