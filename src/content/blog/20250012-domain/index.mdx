---
publish: false
title: "すでに運用中のCloudflare Pagesのサイトを独自ドメインに移行してみた"
publishDate: 2025-12-31 17:45:00 +09:00
description: ""
---

## ドメイン購入

-shi -ku

英数字IDとして主に使用している「DG-7D」に合わせることと、できるだけ短くすることを考慮し、`dg7.dev`とした。普通に既存のCloudflareのアカウントで購入した。カードはKyashが使えた。

[公式FAQ](https://www.cloudflare.com/ja-jp/plans/faq/#:~:text=%E8%AB%8B%E6%B1%82%E6%97%A5%E3%81%AF%E3%81%84%E3%81%A4%E3%81%A7%E3%81%99%E3%81%8B%EF%BC%9F)には「はじめて支払プランを選択された日の日付が、毎月の請求日になります」とあったが、中途半端な日付で請求されても気持ち悪いので、月始めに購入した。12月1日の午前8時に購入したところ、「2026年11月1日 に更新」と表示され、てっきりUTCでは11月だったために11月始まりになってしまった(30日分くらい無駄になった)のかと思ったが、この「更新」はドメインの有効期限の30日前(31日と1日の人がいたので恐らくそう)となるだけで、有効期限はきっかり1年の2026年12月1日だった。

## Cloudflare Pagesの設定

`dg7.dev`からCloudflare Pagesでホストしているサイトにアクセスできるようにするためには、[公式ドキュメント](https://developers.cloudflare.com/pages/configuration/custom-domains/)に従って設定すればよい。CNAMEが自動で設定されるが、これだけでは従来の`azumino.pages.dev`も同時に存在する状態になってしまう。同ドキュメントでは`*.pages.dev`へのアクセスを要認証にするかリダイレクトを設定するかが選択肢として挙げられているが、今回は新規サイトではなく既存サイトの移行であるため、後者を選択した。

リダイレクトについては検索すると「ルール」のほうを使う記事も出てくるが、公式ドキュメントに従い[一括リダイレクト(Bulk Redirects)](https://developers.cloudflare.com/rules/url-forwarding/bulk-redirects/)を使用した。ドメインごとのダッシュボードではなくアカウント全体のダッシュボードのほうにある。詳細な手順は画面に従うだけなので割愛する。ステータスは恒久な移動を示す301、クエリ文字列は保持、サブドメインは含めず(dev環境は残す)、サブパスは一致させ、パスサフィックスは保持する。

## 検索エンジンの設定

### サイトの追加

`*.pages.dev`は自分の所有するドメインではないため、サイトに特定のファイルを配置するという方法で認証をしていたが、独自ドメインであればドメイン単位での認証ができるようになる。

Google Search Consoleでは、Cloudflareと謎の連携をすることができ、ボタンをぽちぽちしているだけで勝手にDNSレコードが追加され、認証が完了した。Bing Webmaster Toolsでは従来のファイルを配置する方法で認証した。このファイルはアカウントごとに発行されるもので、別のサイトでも使い回すことができるため、内容を維持した移行である今回は追加のアップロードは不要だった。DNSレコードで認証したほうがなんかつよそうだが、一旦ファイルで認証すると変更できなさそうなので放置しておく。多分ファイルを破壊すれば再認証を求められるが、古いほうの認証も外れてしまうのでやるとしても移行が済んでからである。

Googleのほうは1日待つと情報が出るよんみたいなことが書かれていたが、実際にはn日経たないと出てこなかった。ただ、1日くらい経った時点で`site:dg7.dev`でいくつかページが出るようにはなっていた。Bingは最大48時間かかると表示され、`site:dg7.dev`では表示されていなかった。そもそも数週間前から元のドメインでも結果が出ない状態だったため、何かが壊れている。

Bingのほうはサイトマップの送信を推奨してきたため、それぞれでサイトマップを送信しておいた。Google Search Consoleはバグり散らかしていて`*.pages.dev`のころは`s.xml`みたいなふざけた名前にしないとサイトマップを読み込んでくれなかったが、独自ドメインにしたら普通に読み込んでくれるようになった。

### サイトの移行

Google Search Consoleでは、移行元のサイトから別のサイトに移行するための[アドレス変更ツール](https://support.google.com/webmasters/answer/9370220)なる機能が用意されているため、これを利用した。移行先のサイトが登録されていない場合はここで登録をすることができるが、登録後に画面が戻ってしまうため、改めて移行画面を開く必要があった。旧ドメインからの流入がなくなるまでこの機能を有効にしておけばよいらしい。

Bing Webmaster Toolsのほうにはサイト移行の機能はぱっと見存在しなかった。かつては存在していたようで、説明をしている記事がいくつも出てくるが、古い情報だったようである。古いほうで一括でクロールを要求することで、301リダイレクトをいい感じに処理してくれないかなと祈っている。

### Crawler Hintsの設定

Bingはサイト側から変更のあったページを通知してインデックスしてもらうIndexNowという機能に対応しているが、`*.pages.dev`のころはCloudflare側では対応していなかった。独自ドメインにしたことでIndexNowに対応するCrawler Hintsなる機能が使えるようになり、Bing Webmaster Toolsに「IndexNow使えよ」という通知が出ることがなくなった。

## Email Routing

Cloudflareでは追加料金なしでEmail Routingという機能を使うことができる。これは独自ドメインでメールを受信し、指定した外部メールアドレスに転送するというだけの機能であり、送信はできない。受信メールアドレスのユーザ名部分(@の前)によって振り分けたり、逆にすべてを一つのアドレスに転送したり(初回設定時に条件設定みたいなのが出るがスキップできる)することができる。なんか色々複雑な処理をすることもできるらしい。

送信について、無料のGmailやOutlookでも送信元を独自ドメインに設定することはでき、これを送信の設定としている記事が多く見られるが、これはヘッダFromを勝手に書き換えているだけであり、なりすましと区別がつかない。配信元サーバ(エンベロープFrom)や署名のドメインはGmailやOutlookであるため、SPF(送信元サーバのIPアドレスがドメイン側で認められているか)やDKIM(署名時点から中身が変わっていないか)には合格するが、それら(のどちらか一方)とヘッダFromの整合性を要求するDMARCアラインメントには適合せず、受信側で迷惑メール扱いされる可能性が高い。真っ当な送信を行いたい場合は、DKIM等の面倒を見てくれるサービス(GoogleやMicrosoftでは有料)を使う必要がある。